# -*- coding: utf-8 -*-

# --- 1. Gerekli KÃ¼tÃ¼phaneleri YÃ¼kle ---
!pip install Flask Flask-Cors requests pyngrok google-generativeai -q

# --- 2. KÃ¼tÃ¼phaneleri ve ModÃ¼lleri Ä°Ã§e Aktar ---
import os
import requests
from flask import Flask, request, jsonify
from flask_cors import CORS
from pyngrok import ngrok, conf
import google.generativeai as genai
import threading

# --- 3. API AnahtarlarÄ±nÄ± ve Ngrok Token'Ä±nÄ± Al ---
# Colab Secrets'a GEMINI_API_KEY, OPENROUTER_API_KEY ve NGROK_AUTHTOKEN ekleyin
try:
    from google.colab import userdata
    GEMINI_API_KEY = userdata.get('GEMINI_API_KEY')
    OPENROUTER_API_KEY = userdata.get('OPENROUTER_API_KEY') # OpenRouter anahtarÄ±nÄ± al
    NGROK_AUTHTOKEN = userdata.get('NGROK_AUTHTOKEN')
    print("API anahtarlarÄ± ve Ngrok Authtoken Colab Secrets'tan alÄ±ndÄ±.")

    # Gemini API'sini yapÄ±landÄ±r
    if GEMINI_API_KEY:
        genai.configure(api_key=GEMINI_API_KEY)
        print("Gemini API baÅŸarÄ±yla yapÄ±landÄ±rÄ±ldÄ±.")
    else:
        print("UyarÄ±: Gemini API anahtarÄ± bulunamadÄ±.")

    # Ngrok'u yapÄ±landÄ±r
    if NGROK_AUTHTOKEN:
        conf.get_default().auth_token = NGROK_AUTHTOKEN
        print("Ngrok Authtoken baÅŸarÄ±yla ayarlandÄ±.")
    else:
        print("UyarÄ±: Ngrok Authtoken bulunamadÄ±. Ngrok tÃ¼neli kÄ±sÄ±tlÄ± olabilir.")

    if not OPENROUTER_API_KEY:
        print("UyarÄ±: OpenRouter API anahtarÄ± bulunamadÄ±.")


except ImportError:
    print("Google Colab ortamÄ±nda deÄŸilsiniz veya userdata modÃ¼lÃ¼ bulunamadÄ±.")
    GEMINI_API_KEY = None
    OPENROUTER_API_KEY = None
    NGROK_AUTHTOKEN = None
except KeyError as e:
     print(f"Colab Secrets'ta eksik anahtar: {e}. LÃ¼tfen sol menÃ¼den (ğŸ”‘) gerekli anahtarlarÄ± ekleyin.")
     if 'GEMINI_API_KEY' not in locals(): GEMINI_API_KEY = None
     if 'OPENROUTER_API_KEY' not in locals(): OPENROUTER_API_KEY = None
     if 'NGROK_AUTHTOKEN' not in locals(): NGROK_AUTHTOKEN = None
except Exception as e:
    print(f"API anahtarÄ± veya Ngrok token yapÄ±landÄ±rÄ±lÄ±rken hata: {e}")
    GEMINI_API_KEY = None
    OPENROUTER_API_KEY = None
    NGROK_AUTHTOKEN = None


# --- 4. Flask UygulamasÄ±nÄ± BaÅŸlat ---
app = Flask(__name__)
CORS(app)

# --- 5. Bilinen Modeller (Bilgi amaÃ§lÄ±, katÄ± kontrol iÃ§in deÄŸil) ---
# Bu liste artÄ±k sadece bilgi veya varsayÄ±lanlar iÃ§in kullanÄ±labilir.
# GerÃ§ek kontrol provider'a gÃ¶re yapÄ±lacak.
known_models_info = {
    # Gemini Modelleri
    "gemini-pro": { "name": "Gemini 1.0 Pro (Google)", "provider": "google" },
    "gemini-1.5-flash-latest": { "name": "Gemini 1.5 Flash (Google)", "provider": "google" },
    "gemini-2.5-flash-preview-04-17": { "name": "Gemini 2.5 Flash Preview (Google)", "provider": "google" },
    # OpenRouter Ã–rnekleri
    "openai/gpt-4o-mini": { "name": "GPT-4o Mini (OpenRouter)", "provider": "openrouter" },
    "anthropic/claude-3-haiku-20240307": { "name": "Claude 3 Haiku (OpenRouter)", "provider": "openrouter" },
    "mistralai/mistral-7b-instruct": { "name": "Mistral 7B Instruct (OpenRouter)", "provider": "openrouter" },
    "gryphe/mythomax-l2-13b": { "name": "MythoMax L2 13B (OpenRouter)", "provider": "openrouter", "isPremium": True }
}


# --- 6. AI API Ã‡aÄŸrÄ± FonksiyonlarÄ± ---

def call_gemini_api(prompt, model_id="gemini-pro", persona=""):
    """Calls Google Gemini API using the official library."""
    if not GEMINI_API_KEY: return "Gemini API anahtarÄ± Colab Secrets'ta ayarlanmamÄ±ÅŸ."
    # Modelin Gemini'ye ait olup olmadÄ±ÄŸÄ±nÄ± basitÃ§e kontrol et (Ã¶rn: ID'de 'gemini' geÃ§iyor mu?)
    # Veya bilinen listeye bakÄ±labilir ama katÄ± olmamalÄ±.
    # if model_id not in known_models_info or known_models_info[model_id]["provider"] != "google":
    #     print(f"UyarÄ±: Bilinmeyen Gemini modeli istendi: {model_id}")
        # Yine de Ã§aÄŸÄ±rmayÄ± deneyebiliriz veya hata verebiliriz. Åimdilik deneyelim.

    try:
        default_max_output = 8192
        generation_config = {"temperature": 0.7, "top_p": 1, "top_k": 1, "max_output_tokens": default_max_output}
        safety_settings = [ {"category": c, "threshold": "BLOCK_MEDIUM_AND_ABOVE"} for c in ["HARM_CATEGORY_HARASSMENT", "HARM_CATEGORY_HATE_SPEECH", "HARM_CATEGORY_SEXUALLY_EXPLICIT", "HARM_CATEGORY_DANGEROUS_CONTENT"]]
        actual_model_name_for_api = model_id # Gemini iÃ§in ID genellikle aynÄ±dÄ±r
        model = genai.GenerativeModel(model_name=actual_model_name_for_api, generation_config=generation_config, safety_settings=safety_settings)
        full_prompt = f"Senin gÃ¶revin: {persona if persona else 'yardÄ±mcÄ± bir asistansÄ±n'}. KullanÄ±cÄ±nÄ±n mesajÄ±: {prompt}"
        chat = model.start_chat(history=[])
        response = chat.send_message(full_prompt)
        return response.text.strip()
    except Exception as e:
         print(f"Gemini KÃ¼tÃ¼phane HatasÄ± (Model: {model_id}): {e}")
         error_message = str(e)
         if "API key not valid" in error_message: return "Gemini API hatasÄ±: GeÃ§ersiz API anahtarÄ±."
         # Model bulunamadÄ± hatasÄ±nÄ± daha genel yakala
         elif "model" in error_message and ("not found" in error_message or "does not exist" in error_message or "permission denied" in error_message):
              return f"Gemini API hatasÄ±: '{model_id}' modeli bulunamadÄ± veya bu API anahtarÄ± ile eriÅŸilemiyor."
         elif "User location is not supported" in error_message: return "Gemini API hatasÄ±: Konum desteklenmiyor."
         elif "RESOURCE_EXHAUSTED" in error_message: return "Gemini API hatasÄ±: Kaynaklar tÃ¼kendi."
         return f"Gemini API hatasÄ±: {error_message}"

def call_openrouter_api(prompt, model_id, persona=""):
    """Calls OpenRouter API."""
    if not OPENROUTER_API_KEY: return "OpenRouter API anahtarÄ± Colab Secrets'ta ayarlanmamÄ±ÅŸ."
    # Model ID'sinin listede olup olmadÄ±ÄŸÄ±nÄ± kontrol etmeye gerek yok, doÄŸrudan deneyeceÄŸiz.

    api_url = "https://openrouter.ai/api/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "Content-Type": "application/json",
        # "HTTP-Referer": "YOUR_SITE_URL", # Gerekirse ekleyin
        # "X-Title": "YOUR_APP_NAME", # Gerekirse ekleyin
    }
    system_prompt = f"Sen {persona if persona else 'yardÄ±mcÄ± bir asistansÄ±n'}."
    data = { "model": model_id, "messages": [{"role": "system", "content": system_prompt}, {"role": "user", "content": prompt}], "max_tokens": 2048, "temperature": 0.7 }
    try:
        response = requests.post(api_url, headers=headers, json=data, timeout=45)
        response.raise_for_status() # 4xx veya 5xx hatalarÄ±nda exception fÄ±rlatÄ±r
        result = response.json()
        return result.get("choices", [{}])[0].get("message", {}).get("content", "YanÄ±t alÄ±namadÄ±.").strip()
    except requests.exceptions.RequestException as e:
        print(f"OpenRouter API HatasÄ± (Model: {model_id}): {e}")
        error_detail = ""
        status_code = response.status_code if 'response' in locals() and response else None
        try: error_detail = response.json().get('error', {}).get('message', str(e))
        except: error_detail = str(e)

        if status_code == 401: return "OpenRouter API hatasÄ±: GeÃ§ersiz API anahtarÄ±."
        if status_code == 402: return "OpenRouter API hatasÄ±: Kredi yetersiz."
        if status_code == 429: return "OpenRouter API hatasÄ±: HÄ±z limiti aÅŸÄ±ldÄ±."
        # Model bulunamadÄ± hatasÄ± (400 veya 404 olabilir)
        if status_code in [400, 404] and ("model not found" in error_detail.lower() or "invalid model" in error_detail.lower()):
             return f"OpenRouter API hatasÄ±: '{model_id}' modeli bulunamadÄ± veya desteklenmiyor."
        if status_code == 400 and "context length" in error_detail.lower(): return "OpenRouter API hatasÄ±: Ä°stek, modelin context limitini aÅŸÄ±yor."
        return f"OpenRouter API hatasÄ±: {error_detail} (Kod: {status_code})"
    except Exception as e:
        print(f"Beklenmedik Hata (OpenRouter - Model: {model_id}): {e}")
        return "OpenRouter yanÄ±tÄ± iÅŸlenirken hata."


# --- 7. API Endpoint (/api/chat) ---
@app.route('/api/chat', methods=['POST'])
def chat_handler():
    """Handles chat requests, routing to Gemini or OpenRouter."""
    data = request.json
    if not data: return jsonify({"error": "GeÃ§ersiz istek"}), 400

    user_message = data.get('message')
    model_id_from_frontend = data.get('modelId') # Frontend'den gelen model ID'si
    character_name = data.get('characterName', 'Bilinmeyen Karakter')
    persona_key = data.get('personaKey', 'default')
    custom_persona_text = data.get('customPersonaText', '')

    if not user_message or not model_id_from_frontend:
        return jsonify({"error": "Eksik bilgi: 'message' ve 'modelId' gerekli."}), 400

    # Persona'yÄ± belirle
    persona_description = ""
    if persona_key == 'custom' and custom_persona_text: persona_description = custom_persona_text
    elif persona_key == 'witty': persona_description = f"{character_name} adÄ±nda esprili bir arkadaÅŸsÄ±n."
    elif persona_key == 'wise': persona_description = f"{character_name} adÄ±nda bilge bir Ã¶ÄŸretmensin."
    else: persona_description = f"{character_name} adÄ±nda yardÄ±mcÄ± bir asistansÄ±n."

    ai_response = "Bir hata oluÅŸtu veya model desteklenmiyor."

    # *** DEÄÄ°ÅTÄ°: Model ID'sine gÃ¶re yÃ¶nlendirme ***
    # ID'de '/' varsa OpenRouter olduÄŸunu varsayalÄ±m
    # Veya bilinen Gemini ID'lerinden biri mi diye kontrol edelim
    is_known_gemini = model_id_from_frontend in known_models_info and known_models_info[model_id_from_frontend]["provider"] == "google"
    is_likely_openrouter = "/" in model_id_from_frontend

    if is_known_gemini:
        if GEMINI_API_KEY:
            print(f"Gemini API Ã§aÄŸrÄ±lÄ±yor: Model={model_id_from_frontend}")
            ai_response = call_gemini_api(user_message, model_id_from_frontend, persona_description)
        else:
            ai_response = "Gemini modeli istendi ancak Gemini API anahtarÄ± ayarlanmamÄ±ÅŸ."
    elif is_likely_openrouter:
        if OPENROUTER_API_KEY:
            print(f"OpenRouter API Ã§aÄŸrÄ±lÄ±yor: Model={model_id_from_frontend}")
            ai_response = call_openrouter_api(user_message, model_id_from_frontend, persona_description)
        else:
            ai_response = "OpenRouter modeli istendi ancak OpenRouter API anahtarÄ± ayarlanmamÄ±ÅŸ."
    else:
         # Ne Gemini ne de OpenRouter formatÄ±na uymuyorsa
         ai_response = f"Desteklenmeyen veya tanÄ±nmayan model ID formatÄ±: '{model_id_from_frontend}'."


    return jsonify({"reply": ai_response})

# --- 8. UygulamayÄ± ve Ngrok TÃ¼nelini BaÅŸlat ---
PORT = 5000

def run_flask():
    print(f"Flask uygulamasÄ± http://localhost:{PORT} adresinde baÅŸlatÄ±lÄ±yor...")
    app.run(port=PORT, use_reloader=False, debug=False)

if __name__ == '__main__':
    try: ngrok.kill()
    except Exception as e: print(f"Mevcut ngrok iÅŸlemleri sonlandÄ±rÄ±lamadÄ± (sorun deÄŸil): {e}")

    try:
        public_url = ngrok.connect(PORT)
        print(f" * Ngrok TÃ¼neli {public_url} -> http://127.0.0.1:{PORT}")
        print("Flask uygulamasÄ± (Gemini & Esnek OpenRouter ile) baÅŸlatÄ±lÄ±yor...")
        # ArtÄ±k tÃ¼m modelleri listelemeye gerek yok, frontend dinamik alÄ±yor
        # print(f" * Bilinen Modeller: {list(known_models_info.keys())}")
        print(f" * Frontend API URL'sini ÅŸununla gÃ¼ncelleyin: {public_url}/api/chat")
        run_flask()
    except Exception as e:
        print(f"Ngrok baÅŸlatÄ±lÄ±rken veya Flask Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken hata oluÅŸtu: {e}")
        error_str = str(e).lower()
        if "authentication failed" in error_str or "authtoken" in error_str: print("Hata: Ngrok kimlik doÄŸrulamasÄ± baÅŸarÄ±sÄ±z oldu. Colab Secrets'taki NGROK_AUTHTOKEN'Ä± kontrol edin.")
        elif "could not connect" in error_str: print("Hata: Ngrok servisine baÄŸlanÄ±lamadÄ±.")
        else: print("Ngrok Authtoken'Ä±nÄ±zÄ±n Colab Secrets'ta doÄŸru ayarlandÄ±ÄŸÄ±ndan emin olun.")

