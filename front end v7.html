<!DOCTYPE html>
<html lang="tr" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş Anime AI Sohbet v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Yusei+Magic&display=swap" rel="stylesheet">

    <style>
        /* Temel Stiller */
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .header-font { font-family: 'Yusei Magic', sans-serif; } /* Font adı düzeltildi */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(230, 230, 230, 0.1); border-radius: 10px; }
        .dark ::-webkit-scrollbar-track { background: rgba(50, 50, 50, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.3); border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.5); }
        .dark ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0) !important; }
        .main-content-shifted { margin-left: 256px; transition: margin-left 0.3s ease-in-out; }
        @media (max-width: 768px) { .main-content-shifted { margin-left: 0; } }

        /* Typing Indicator Styles */
        .ai-typing { display: flex; align-items: end; column-gap: 0.75rem; margin-bottom: 1rem; }
        .typing-indicator-dots span { display: inline-block; width: 8px; height: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite both; }
        .dark .typing-indicator-dots span { background-color: #6b7280; }
        .typing-indicator-dots span:nth-child(1) { animation-delay: 0.2s; }
        .typing-indicator-dots span:nth-child(2) { animation-delay: 0.4s; }
        .typing-indicator-dots span:nth-child(3) { animation-delay: 0.6s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1.0); opacity: 1; } }

        /* Badge Styles */
        .premium-badge { background-color: #ffd700; color: #4a4a4a; font-size: 0.65rem; padding: 1px 4px; border-radius: 4px; margin-left: 6px; font-weight: bold; }
        .free-badge { background-color: #a7f3d0; color: #047857; font-size: 0.65rem; padding: 1px 4px; border-radius: 4px; margin-left: 6px; font-weight: bold; }

        /* Content Section Visibility */
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* Card Styles */
        .character-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-radius: 16px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); }
        .dark .character-card { background: rgba(31, 41, 55, 0.7); border: 1px solid rgba(75, 85, 99, 0.5); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .store-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); border-radius: 12px; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; cursor: pointer; border: 1px solid rgba(255, 255, 255, 0.18); }
        .dark .store-card { background: rgba(55, 65, 81, 0.6); border: 1px solid rgba(75, 85, 99, 0.4); }
        .store-card:hover { transform: translateY(-5px); box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15); }
        .dark .store-card:hover { box-shadow: 0 12px 20px rgba(0, 0, 0, 0.25); }
        .store-card.premium .premium-overlay { position: absolute; top: 0; right: 0; bottom: 0; left: 0; background: rgba(0,0,0,0.4); color: white; display: flex; align-items: center; justify-content: center; border-radius: 12px; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .store-card.premium:hover .premium-overlay { opacity: 1; }

        /* Form Styles */
        .form-input, .form-textarea, .form-select { background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(209, 213, 219, 0.5); border-radius: 8px; padding: 10px 15px; transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s, color 0.2s; color: #1f2937; }
        .dark .form-input, .dark .form-textarea, .dark .form-select { background: rgba(55, 65, 81, 0.8); border-color: rgba(75, 85, 99, 0.7); color: #d1d5db; }
        .dark .form-input::placeholder, .dark .form-textarea::placeholder { color: #9ca3af; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #60a5fa; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3); }
        .dark .form-input:focus, .dark .form-textarea:focus, .dark .form-select:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .form-label { margin-bottom: 6px; display: block; color: #4b5563; font-weight: 500; }
        .dark .form-label { color: #d1d5db; }
        .form-button { background: linear-gradient(to right, #60a5fa, #3b82f6); color: white; font-weight: 600; padding: 10px 20px; border-radius: 8px; transition: opacity 0.2s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); cursor: pointer; }
        .form-button:hover { opacity: 0.9; }

        /* Background Gradient */
        :root { --tw-gradient-from: #a1c4fd; --tw-gradient-to: #c2e9fb; }
        html.dark { --tw-gradient-from: #1f2937; --tw-gradient-to: #374151; }
        body { background: linear-gradient(135deg, var(--tw-gradient-from), var(--tw-gradient-to)); }

        /* TTS Button */
        .tts-button { cursor: pointer; color: #9ca3af; transition: color 0.2s; margin-left: 8px; opacity: 0.7; }
        .tts-button:hover { color: #60a5fa; opacity: 1; }
        .dark .tts-button { color: #6b7280; }
        .dark .tts-button:hover { color: #3b82f6; }

        /* Model Details */
        .model-details { font-size: 0.8rem; color: #6b7280; background-color: rgba(243, 244, 246, 0.6); padding: 8px 12px; border-radius: 6px; margin-top: 8px; border: 1px solid rgba(209, 213, 219, 0.5); }
        .dark .model-details { color: #9ca3af; background-color: rgba(55, 65, 81, 0.5); border: 1px solid rgba(75, 85, 99, 0.4); }
        .model-details strong { color: #4b5563; margin-right: 5px; }
        .dark .model-details strong { color: #d1d5db; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(161, 196, 253, 0.8) 0%, rgba(194, 233, 251, 0.8) 100%); backdrop-filter: blur(10px); z-index: 100; transition: opacity 0.5s ease-out; }
        #login-screen.hidden { opacity: 0; pointer-events: none; }
        .dark #login-screen { background: linear-gradient(135deg, rgba(31, 41, 55, 0.8) 0%, rgba(55, 65, 81, 0.8) 100%); }
        .login-box { background: rgba(255, 255, 255, 0.9); padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; }
        .dark .login-box { background: rgba(31, 41, 55, 0.9); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }

        /* App Container Visibility */
        .app-container { display: none; }
        .app-container.visible { display: flex; }

        /* Sidebar Link Active State */
        .sidebar-link.active { background-color: rgba(96, 165, 250, 0.2); color: #2563eb; font-weight: 500; }
        .dark .sidebar-link.active { background-color: rgba(59, 130, 246, 0.3); color: #93c5fd; }

        /* Model Loading/Error Indicators */
        #model-loading-indicator { font-size: 0.9rem; color: #6b7280; margin-top: 10px; text-align: center; }
        .dark #model-loading-indicator { color: #9ca3af; }
        #model-error-indicator { font-size: 0.9rem; color: #ef4444; margin-top: 10px; text-align: center; } /* Error color updated */

        /* Chat List Styles */
        #chat-list { max-height: 150px; overflow-y: auto; }
        .chat-list-item { display: block; cursor: pointer; padding: 8px 16px; border-radius: 6px; margin-bottom: 4px; transition: background-color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item:hover { background-color: rgba(0, 0, 0, 0.05); }
        .dark .chat-list-item:hover { background-color: rgba(255, 255, 255, 0.08); }
        .chat-list-item.active { background-color: rgba(96, 165, 250, 0.2); color: #2563eb; font-weight: 500; }
        .dark .chat-list-item.active { background-color: rgba(59, 130, 246, 0.3); color: #93c5fd; }

        /* Dropdown */
        .dropdown-content {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
        }
        .dropdown-content:not(.hidden) { /* Use :not(.hidden) to trigger transition */
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
    </style>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: {} } }
    </script>
</head>
<body class="overflow-hidden">

    <div id="login-screen">
        <div class="login-box dark:text-gray-200">
            <h2 class="text-2xl font-bold text-center mb-6 header-font text-blue-600 dark:text-blue-400">Giriş Yap</h2>
            <div id="login-error" class="text-red-500 text-sm mb-4 text-center hidden">Geçersiz kullanıcı adı veya şifre.</div>
            <form id="user-login-form" class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300">Kullanıcı / Premium Girişi</h3>
                <div class="mb-4"> <label for="username" class="form-label">Kullanıcı Adı:</label> <input type="text" id="username" class="form-input w-full" required value="premium"> </div>
                <div class="mb-4"> <label for="password" class="form-label">Şifre:</label> <input type="password" id="password" class="form-input w-full" required value="123"> </div>
                <button type="submit" class="form-button w-full">Giriş Yap</button>
            </form>
            <form id="admin-login-form" class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-gray-700 dark:text-gray-300">Admin Girişi</h3>
                <div class="mb-4"> <label for="admin-username" class="form-label">Admin Kullanıcı Adı:</label> <input type="text" id="admin-username" class="form-input w-full" required value="admin"> </div>
                <div class="mb-4"> <label for="admin-password" class="form-label">Admin Şifre:</label> <input type="password" id="admin-password" class="form-input w-full" required value="admin12345"> </div>
                <button type="submit" class="form-button w-full bg-gradient-to-r from-purple-500 to-indigo-600">Admin Girişi</button>
            </form>
            <div class="text-center mt-4"> <button id="continue-guest-button" class="text-sm text-blue-600 dark:text-blue-400 hover:underline focus:outline-none">Oturum açmadan devam et</button> </div>
        </div>
    </div>

    <div id="app-container" class="app-container">
        <aside id="sidebar" class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-lg w-64 h-full fixed top-0 left-0 z-30 shadow-lg transform -translate-x-full md:translate-x-0 overflow-y-auto p-4 space-y-4 border-r border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center mb-4"> <h2 class="text-xl font-bold text-blue-600 dark:text-blue-400 header-font">Menü</h2> <button id="logout-button" title="Çıkış Yap" class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 focus:outline-none hidden"> <i class="fas fa-sign-out-alt fa-lg"></i> </button> </div>
            <button id="new-chat-button" class="w-full flex items-center justify-center px-4 py-2 mb-4 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200 shadow focus:outline-none focus:ring-2 focus:ring-blue-400"> <i class="fas fa-plus mr-2"></i> Yeni Sohbet </button>
            <div class="border-t border-b border-gray-200 dark:border-gray-700 py-2 my-2">
                <h3 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase px-4 mb-2">Sohbetler</h3>
                <ul id="chat-list" class="text-sm text-gray-700 dark:text-gray-300"> </ul>
            </div>
            <nav id="sidebar-nav" class="space-y-2">
                <a href="#" data-section="chat" class="sidebar-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200 active"> <i class="fas fa-comments fa-fw mr-3 text-blue-500 dark:text-blue-400"></i> Sohbet </a>
                <a href="#" data-section="character-card" class="sidebar-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200"> <i class="fas fa-id-card fa-fw mr-3 text-purple-500 dark:text-purple-400"></i> Karakter Kartı </a>
                <a href="#" data-section="persona-settings" class="sidebar-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200"> <i class="fas fa-theater-masks fa-fw mr-3 text-red-500 dark:text-red-400"></i> Persona Ayarları </a>
                <a href="#" data-section="character-store" class="sidebar-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200"> <i class="fas fa-store fa-fw mr-3 text-green-500 dark:text-green-400"></i> Karakter Mağazası </a>
                <a href="#" data-section="upload-character" id="menu-upload-character" class="sidebar-link hidden admin-only flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200"> <i class="fas fa-upload fa-fw mr-3 text-orange-500 dark:text-orange-400"></i> Karakter Yükle </a>
                <a href="#" data-section="settings" id="menu-settings" class="sidebar-link flex items-center px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200"> <i class="fas fa-cog fa-fw mr-3 text-gray-500 dark:text-gray-400"></i> Ayarlar </a>
            </nav>
            <div class="pt-4 border-t border-gray-200 dark:border-gray-700"> <button id="premium-upgrade-button" class="w-full text-center bg-gradient-to-r from-pink-500 to-yellow-500 text-white text-sm font-semibold py-2 px-3 rounded-lg hover:opacity-90 transition-opacity shadow-md hidden" onclick="showPremiumModal()"> Premium'a Yükselt ✨ </button> <div id="user-status" class="text-center text-xs mt-2 text-gray-500 dark:text-gray-400">Durum: Misafir</div> </div>
        </aside>

        <div id="main-content" class="flex-1 flex flex-col h-screen md:ml-64 transition-all duration-300">
            <header class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm shadow-md p-4 flex justify-between items-center sticky top-0 z-20 border-b border-gray-200 dark:border-gray-700">
                <button id="menu-toggle" class="md:hidden text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none"> <i class="fas fa-bars fa-lg"></i> </button>
                <h1 id="header-title" class="text-xl font-semibold text-gray-800 dark:text-gray-200">Sohbet</h1>
                <div class="flex items-center space-x-4">
                    <div class="relative dropdown">
                        <button id="character-select-button" class="flex items-center text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none">
                            <img id="selectedCharacterAvatar" src="https://placehold.co/32x32/60a5fa/ffffff?text=A&font=lora" alt="Seçili Karakter" class="w-8 h-8 rounded-full mr-2 border-2 border-blue-300 dark:border-blue-600">
                            <span id="selectedCharacterName" class="text-sm font-medium hidden sm:inline">Asuna</span>
                            <i class="fas fa-chevron-down ml-1 text-xs hidden sm:inline"></i>
                        </button>
                        <div id="characterDropdown" class="dropdown-content mt-2 right-0 hidden absolute bg-white dark:bg-gray-700 shadow-lg rounded-md py-1 w-48 z-40 border dark:border-gray-600">
                            </div>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto">
                <section id="chat" class="content-section active h-full flex flex-col">
                    <main id="chatbox" class="flex-1 overflow-y-auto p-6 space-y-5">
                        <div id="ai-typing-indicator" class="ai-typing hidden">
                            <img id="typingAvatarAI" src="https://placehold.co/40x40/cccccc/ffffff?text=?" alt="AI Avatar" class="w-10 h-10 rounded-full border-2 border-white dark:border-gray-600 shadow-md flex-shrink-0">
                            <div class="bg-white dark:bg-gray-700 p-3 rounded-lg rounded-bl-none shadow-lg">
                                <div class="typing-indicator-dots">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        </div>
                        </main>
                    <footer class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-t border-gray-200/50 dark:border-gray-700/50 p-4 sticky bottom-0">
                        <div class="flex items-center space-x-3">
                            <input id="userInput" type="text" placeholder="Mesajını buraya yaz..." class="flex-1 form-input rounded-full py-3 px-5 text-sm shadow-inner">
                            <button id="micButton" class="text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none transition-colors duration-200"> <i class="fas fa-microphone fa-lg"></i> </button>
                            <button id="sendButton" class="bg-gradient-to-r from-blue-500 to-indigo-600 hover:opacity-90 text-white font-semibold py-3 px-6 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-150 ease-in-out shadow-md hover:shadow-lg"> Gönder </button>
                        </div>
                    </footer>
                </section>

                <section id="character-card" class="content-section p-6 md:p-10">
                    <div class="character-card max-w-lg mx-auto p-8 text-center">
                         <img id="card-avatar" src="https://placehold.co/150x150/60a5fa/ffffff?text=A&font=lora" alt="Karakter Avatar" class="w-36 h-36 rounded-full mx-auto mb-6 border-4 border-white dark:border-gray-500 shadow-lg">
                         <h2 id="card-name" class="text-3xl font-bold text-gray-800 dark:text-gray-100 header-font mb-2">Asuna</h2>
                         <p id="card-description" class="text-gray-600 dark:text-gray-300 mb-6 px-4">...</p>
                         <div id="card-tags" class="flex justify-center space-x-4 flex-wrap gap-2"></div>
                         <div id="card-premium-status" class="mt-6"></div>
                    </div>
                </section>

                <section id="persona-settings" class="content-section p-6 md:p-10">
                     <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-8">Persona Ayarları</h2>
                     <div class="max-w-xl mx-auto space-y-8">
                         <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md p-6 rounded-lg shadow-lg border border-gray-200/50 dark:border-gray-700/50">
                             <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">AI Personası Seçimi</h3>
                             <div>
                                 <label for="persona-select" class="form-label">Hazır Personalar:</label>
                                 <select id="persona-select" class="form-select w-full mb-4">
                                     <option value="default">Varsayılan Yardımcı</option>
                                     <option value="witty">Esprili Arkadaş</option>
                                     <option value="wise">Bilge Öğretmen</option>
                                     <option value="custom">Özel Tanım</option>
                                 </select>
                             </div>
                             <div id="custom-persona-input" class="hidden">
                                 <label for="custom-persona-text" class="form-label">Özel Persona Tanımı:</label>
                                 <textarea id="custom-persona-text" rows="4" class="form-textarea w-full" placeholder="AI'ın nasıl davranmasını istediğinizi buraya yazın..."></textarea>
                             </div>
                             <button id="save-persona-button" class="form-button mt-4 text-sm px-4 py-2"> Personayı Kaydet </button>
                             <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Seçilen persona, AI'ın yanıt tarzını etkileyecektir.</p>
                         </div>
                     </div>
                </section>

                <section id="character-store" class="content-section p-6 md:p-10">
                    <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-6">Karakter Mağazası</h2>
                    <div id="store-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        </div>
                </section>

                <section id="upload-character" class="content-section p-6 md:p-10">
                    <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-6">Yeni Karakter Yükle (Admin)</h2>
                    <div class="max-w-xl mx-auto bg-white/80 dark:bg-gray-800/80 backdrop-blur-md p-8 rounded-lg shadow-lg border border-gray-200/50 dark:border-gray-700/50">
                        <form id="upload-form" class="space-y-6">
                            <div><label for="upload-name" class="form-label">Karakter Adı:</label><input type="text" id="upload-name" name="name" class="form-input w-full" required></div>
                            <div><label for="upload-avatar" class="form-label">Avatar PNG URL:</label><input type="url" id="upload-avatar" name="avatar" class="form-input w-full" placeholder="https://example.com/avatar.png" required><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Lütfen karakter resminin direkt URL'sini girin.</p></div>
                            <div><label for="upload-description" class="form-label">Kısa Açıklama:</label><textarea id="upload-description" name="description" rows="3" class="form-textarea w-full" required></textarea></div>
                            <div><label for="upload-tags" class="form-label">Etiketler (virgülle ayırın):</label><input type="text" id="upload-tags" name="tags" class="form-input w-full" placeholder="Savaşçı, AoT, Güçlü"></div>
                            <div><label for="upload-is-premium" class="form-label">Premium Karakter mi?</label> <select id="upload-is-premium" name="isPremium" class="form-select w-full"> <option value="false">Hayır (Standart)</option> <option value="true">Evet (Premium)</option> </select> </div>
                            <div><label for="upload-json" class="form-label">Karakter Verisi (JSON):</label><textarea id="upload-json" name="json_data" rows="6" class="form-textarea w-full font-mono text-sm" placeholder='{...}'></textarea><p class="text-xs text-gray-500 dark:text-gray-400 mt-1">İsteğe bağlı.</p></div>
                            <button type="submit" class="form-button w-full"><i class="fas fa-cloud-upload-alt mr-2"></i> Karakteri Yükle</button>
                        </form>
                    </div>
                </section>

                <section id="settings" class="content-section p-6 md:p-10">
                     <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-200 mb-8">Ayarlar</h2>
                     <div class="max-w-xl mx-auto space-y-8">
                         <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md p-6 rounded-lg shadow-lg border border-gray-200/50 dark:border-gray-700/50">
                             <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">AI Modeli Seçimi</h3>
                             <div id="model-loading-indicator" class="hidden"> <i class="fas fa-spinner fa-spin mr-2"></i> Modeller yükleniyor... </div>
                             <div id="model-error-indicator" class="text-red-500 text-sm hidden"> Modeller yüklenirken bir hata oluştu. </div>
                             <select id="model-select" class="form-select w-full hidden"> </select>
                             <div id="model-details-display" class="model-details hidden"></div>
                             <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Kullanılacak yapay zeka modelini seçin.</p>
                         </div>
                         <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md p-6 rounded-lg shadow-lg border border-gray-200/50 dark:border-gray-700/50">
                             <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Görünüm</h3>
                             <div class="flex items-center justify-between">
                                 <span class="text-gray-600 dark:text-gray-300">Karanlık Mod</span>
                                 <label class="relative inline-flex items-center cursor-pointer">
                                     <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                                     <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                                 </label>
                             </div>
                         </div>
                     </div>
                </section>
            </div>
        </div>
    </div>

    <div id="premiumModal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 max-w-md w-full text-center relative transform transition-all duration-300 scale-95 opacity-0">
            <button onclick="closePremiumModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="fas fa-times fa-lg"></i></button>
            <h2 class="text-2xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-yellow-500">Premium'a Geçin! ✨</h2>
            <p class="text-gray-600 dark:text-gray-300 mb-6">Özel karakterlerin, gelişmiş AI modellerinin ve daha birçok özelliğin kilidini açın!</p>
            <ul class="text-left space-y-2 mb-8 px-4 text-gray-700 dark:text-gray-300">
                <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Özel Anime Karakterleri</li>
                <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Gelişmiş AI Modelleri</li>
                <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Daha Hızlı Yanıtlar</li>
                <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Reklamsız Deneyim</li>
                <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Yeni Karakter Yükleme (Admin)</li>
                <li class="flex items-center"><i class="fas fa-check-circle text-green-500 mr-2"></i> Özel Persona Tanımlama</li>
            </ul>
            <button class="w-full bg-gradient-to-r from-pink-500 to-yellow-500 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 transition duration-150 ease-in-out shadow-md hover:shadow-lg hover:scale-105 transform">Hemen Yükselt!</button>
        </div>
    </div>

    <script>
        // --- DOM Elementleri ---
        // Değişkenler initializeApp içinde atanacak
        let loginScreen, appContainer, userLoginForm, adminLoginForm, continueGuestButton, loginError, sidebar, sidebarNav, mainContent, menuToggle, headerTitle, contentSections, chatbox, userInput, sendButton, micButton, aiTypingIndicator, selectedCharacterAvatar, selectedCharacterName, characterDropdown, typingAvatarAI, premiumModal, modelSelect, modelDetailsDisplay, storeGrid, uploadForm, darkModeToggle, personaSelect, customPersonaInputDiv, customPersonaText, cardAvatar, cardName, cardDescription, cardTags, cardPremiumStatus, userStatusDiv, premiumUpgradeButton, menuUploadCharacter, menuSettings, logoutButton, modelLoadingIndicator, modelErrorIndicator, newChatButton, chatListElement, characterSelectButton, savePersonaButton;

        // --- Uygulama Durumu ve Veriler ---
        let authState = { isLoggedIn: false, isAdmin: false, username: null, isPremium: false };
        // Frontend karakter verisi kaynağı (başlangıç)
        let availableCharacters = [
            { id: 'asuna', name: 'Asuna', avatar: 'https://placehold.co/150x150/60a5fa/ffffff?text=A&font=lora', description: 'Hızlı ve yetenekli bir kılıç ustası. Sadık ve yardımsever bir arkadaş.', tags: ['Kılıç Ustası', 'Yardımsever', 'SAO'], isPremium: false },
            { id: 'mikasa', name: 'Mikasa', avatar: 'https://placehold.co/150x150/7c3aed/ffffff?text=M&font=lora', description: 'Güçlü ve koruyucu bir savaşçı. Sakin ama kararlı.', tags: ['Savaşçı', 'Koruyucu', 'AoT'], isPremium: false },
            { id: 'zero-two', name: 'Zero Two', avatar: 'https://placehold.co/150x150/f87171/ffffff?text=Z&font=lora', description: 'Gizemli ve çekici pilot. Özgür ruhlu ve bazen tehlikeli.', tags: ['Pilot', 'Gizemli', 'Darling'], isPremium: true },
            { id: 'rem', name: 'Rem', avatar: 'https://placehold.co/150x150/3b82f6/ffffff?text=R&font=lora', description: 'Sadık ve becerikli bir hizmetçi. Sakin görünüşünün altında güçlü duygular yatar.', tags: ['Hizmetçi', 'Sadık', 'Re:Zero'], isPremium: true },
            { id: 'levi', name: 'Levi', avatar: 'https://placehold.co/150x150/4b5563/ffffff?text=L&font=lora', description: 'İnsanlığın en güçlü askeri. Soğukkanlı ve disiplinli.', tags: ['Asker', 'Disiplinli', 'AoT'], isPremium: true },
        ];
        let availableModels = []; // Modeller API'den çekilecek
        let currentCharacter = availableCharacters[0]; // Varsayılan karakter
        let currentModel = null; // Başlangıçta model seçili değil
        let currentPersona = 'default'; // Varsayılan persona
        let allChatHistories = {}; // Tüm sohbet geçmişlerini tutacak nesne
        let activeChatId = null; // Aktif sohbetin ID'si

        // !!! ÖNEMLİ: Backend (Flask/Ngrok) çalıştığında oluşan URL'yi buraya yapıştırın !!!
        // Bu URL, Colab'da backend kodu çalıştırıldığında çıktıda görünen Ngrok URL'si olmalıdır.
        // Örnek: const apiUrl = 'https://xxxx-xxxx-xxxx-xxxx.ngrok-free.app/api/chat';
        // Lütfen kendi Ngrok URL'niz ile güncelleyin!
        const apiUrl = 'https://b452-34-125-128-12.ngrok-free.app/api/chat'; // Bu satırı DÜZENLE!

        // OpenRouter model listesi URL'si (ücretsiz modelleri çekmek için)
        const openRouterModelsUrl = 'https://openrouter.ai/api/v1/models';

        // --- Fonksiyonlar ---

        /**
         * OpenRouter API'sinden modelleri çeker ve Gemini modelleriyle birleştirir.
         * Sadece ücretsiz modelleri listeler.
         */
        async function fetchOpenRouterModels() {
            if (modelLoadingIndicator) modelLoadingIndicator.classList.remove('hidden');
            if (modelErrorIndicator) modelErrorIndicator.classList.add('hidden');
            if (modelSelect) modelSelect.classList.add('hidden');

            // Backend'de de tanımlı olan temel Gemini modelleri
            const geminiModels = [
                 { id: "gemini-pro", name: "Gemini 1.0 Pro (Google)", contextLength: "32K", outputTokenLimit: 8192, isFree: true, provider: "google" },
                 { id: "gemini-1.5-flash-latest", name: "Gemini 1.5 Flash (Google)", contextLength: "1M", outputTokenLimit: 8192, isFree: true, provider: "google" },
            ];

            try {
                // OpenRouter'dan model listesini çek
                const response = await fetch(openRouterModelsUrl);
                if (!response.ok) {
                    let errorReason = `API isteği başarısız: ${response.status}`;
                    // CORS veya ağ hatası durumunda daha açıklayıcı mesaj
                    if (response.type === 'opaque' || response.status === 0) { errorReason = "OpenRouter API'sine erişilemiyor (CORS veya ağ sorunu)."; }
                    throw new Error(errorReason);
                }
                const data = await response.json();

                // OpenRouter'dan gelen modelleri filtrele ve formatla
                const fetchedModels = data.data
                    .map(model => ({
                        id: model.id, // Model ID (örn: "openai/gpt-4o-mini")
                        name: model.name || model.id, // Model adı
                        contextLength: model.context_length ? `${Math.round(model.context_length / 1000)}K` : 'N/A', // Context uzunluğu
                        // Ücretsiz olup olmadığını kontrol et (fiyat bilgisi yoksa veya çok düşükse)
                        isFree: !model.pricing || (parseFloat(model.pricing?.prompt || "1") <= 0.00000001 && parseFloat(model.pricing?.completion || "1") <= 0.00000001),
                        provider: 'openrouter' // Sağlayıcıyı belirt
                    }))
                    .filter(model => model.isFree); // Sadece ücretsiz modelleri tut

                console.log("Ücretsiz OpenRouter Modelleri:", fetchedModels);
                // Gemini ve OpenRouter modellerini birleştir
                availableModels = [...geminiModels, ...fetchedModels];
                initializeModels(); // Model listesini UI'da güncelle
                if (modelLoadingIndicator) modelLoadingIndicator.classList.add('hidden');
                if (modelSelect) modelSelect.classList.remove('hidden');
            } catch (error) {
                console.error("OpenRouter modelleri çekilirken hata:", error);
                if (modelLoadingIndicator) modelLoadingIndicator.classList.add('hidden');
                if (modelErrorIndicator) {
                    modelErrorIndicator.textContent = `Modeller yüklenirken hata: ${error.message}. Sadece Gemini modelleri listeleniyor.`;
                    modelErrorIndicator.classList.remove('hidden');
                }
                // Hata durumunda sadece Gemini modellerini kullan
                availableModels = geminiModels;
                initializeModels();
                if (modelSelect) modelSelect.classList.remove('hidden');
            }
        }

        /**
         * Belirtilen ID'ye sahip bölümü gösterir, diğerlerini gizler ve UI güncellemelerini yapar.
         * @param {string} sectionId Gösterilecek bölümün ID'si.
         */
        function showSection(sectionId) {
            if (!contentSections || !sidebar || !mainContent || !headerTitle ) { console.error("showSection: DOM elements not ready!"); return; }

            // Admin yetkisi gerektiren bölümlerin kontrolü
            const restrictedSections = ['upload-character'];
            if (restrictedSections.includes(sectionId) && !authState.isAdmin) {
                console.warn("Unauthorized access attempt:", sectionId);
                appendMessage("Bu bölüme erişim yetkiniz yok.", "system");
                return; // Yetkisiz erişimi engelle
            }

            // Sidebar linklerinin aktif durumunu güncelle
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.toggle('active', link.dataset.section === sectionId));
            // Sohbet dışı bir bölüme geçildiyse sohbet listesindeki aktifliği kaldır
            if (sectionId !== 'chat') {
                document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
            }

            // Tüm içerik bölümlerini gizle
            contentSections.forEach(section => section.classList.remove('active'));
            // İstenen bölümü göster
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
                // Başlığı güncelle
                const titles = { chat: 'Sohbet', 'character-card': 'Karakter Kartı', 'persona-settings': 'Persona Ayarları', 'character-store': 'Karakter Mağazası', 'upload-character': 'Karakter Yükle (Admin)', settings: 'Ayarlar' };
                headerTitle.textContent = titles[sectionId] || 'Sohbet';

                // Bölüme özel UI güncellemeleri
                if (sectionId === 'character-card') updateCharacterCard();
                if (sectionId === 'settings') displayModelDetailsFrontend(currentModel?.id); // Model detaylarını göster
            }

            // Mobil görünümde menüyü kapat
            if (window.innerWidth < 768 && sidebar) {
                sidebar.classList.add('-translate-x-full');
            }
        }

        /**
         * Belirtilen ID'ye sahip karakteri seçer ve UI'ı günceller. Premium kontrolü yapar.
         * @param {string} characterId Seçilecek karakterin ID'si.
         */
        function selectCharacter(characterId) {
            const selected = availableCharacters.find(c => c.id === characterId);
            if (!selected) { console.error(`Karakter bulunamadı: ${characterId}`); return; }

            // Premium karakter kontrolü
            if (selected.isPremium && !authState.isPremium && !authState.isAdmin) {
                showPremiumModal(); // Premium modalı göster
                appendMessage(`${selected.name} karakterini kullanmak için Premium üye olmalısınız.`, "system");
                return; // Seçimi engelle
            }

            // Karakteri global state'e ata
            currentCharacter = selected;
            updateCharacterUI(); // Başlık çubuğu, yazıyor göstergesi vb. güncelle

            // Aktif sohbet varsa, karakter değiştiği için geçmişi sıfırla (veya farklı bir strateji izlenebilir)
            if (activeChatId && allChatHistories[activeChatId]) {
                allChatHistories[activeChatId] = []; // Geçmişi temizle
                saveChatsToLocalStorage(); // Değişikliği kaydet
                renderChatMessages(activeChatId); // Temizlenmiş sohbeti göster
                appendMessage(`Artık ${currentCharacter.name} ile konuşuyorsun! (Sohbet geçmişi sıfırlandı)`, 'system');
            } else if (activeChatId) {
                // Sohbet var ama geçmiş yoksa (yeni sohbetse) sadece bilgi ver
                 appendMessage(`Artık ${currentCharacter.name} ile konuşuyorsun!`, 'system');
            }

            // Eğer karakter kartı sekmesi açıksa, onu da güncelle
            if(document.getElementById('character-card')?.classList.contains('active')) updateCharacterCard();

            // Karakter seçim dropdown menüsünü kapat
            if (characterDropdown) characterDropdown.classList.add('hidden');
        }

        /**
         * Belirtilen ID'ye sahip AI modelini seçer ve UI'ı günceller.
         * @param {string} modelId Seçilecek modelin ID'si.
         */
        function selectModel(modelId) {
            const selected = availableModels.find(m => m.id === modelId);
            if (!selected) { console.error(`Model bulunamadı: ${modelId}`); return; }

            // Model değiştiyse ve aktif sohbet varsa geçmişi sıfırla
            if (currentModel && currentModel.id !== selected.id && activeChatId && allChatHistories[activeChatId]) {
                allChatHistories[activeChatId] = []; // Geçmişi temizle
                saveChatsToLocalStorage();
                renderChatMessages(activeChatId);
                appendMessage(`Model ${selected.name} olarak değiştirildi. (Sohbet geçmişi sıfırlandı)`, 'system');
            }

            // Modeli global state'e ata
            currentModel = selected;
            console.log(`Frontend: Model seçildi: ${currentModel.name} (${currentModel.id})`);
            displayModelDetailsFrontend(modelId); // Ayarlar sekmesindeki detayları güncelle
        }

        /**
         * Seçilen modelin detaylarını Ayarlar sekmesinde gösterir.
         * @param {string} modelId Detayları gösterilecek modelin ID'si.
         */
        function displayModelDetailsFrontend(modelId) {
            const model = availableModels.find(m => m.id === modelId);
            if (model && modelDetailsDisplay) {
                const isConsideredPremium = model.isPremium === true; // Explicit premium check
                modelDetailsDisplay.innerHTML = `
                    <span><strong>Context:</strong> ${model.contextLength || 'N/A'}</span>
                    ${model.isFree ? '<span class="free-badge">Ücretsiz</span>' : ''}
                    ${isConsideredPremium ? '| <span class="premium-badge">Premium</span>' : ''}
                `;
                modelDetailsDisplay.classList.remove('hidden');
            } else if (modelDetailsDisplay) {
                modelDetailsDisplay.classList.add('hidden');
            }
        }

        /**
         * Seçili karaktere göre UI elemanlarını (başlık avatarı, yazıyor avatarı vb.) günceller.
         */
        function updateCharacterUI() {
            if (!currentCharacter || !currentCharacter.avatar) { console.error("updateCharacterUI: currentCharacter or avatar undefined."); return; }

            // Başlık çubuğundaki avatar ve isim
            if (selectedCharacterAvatar) selectedCharacterAvatar.src = currentCharacter.avatar.replace('150x150', '32x32'); else console.error("updateCharacterUI: selectedCharacterAvatar not found.");
            if (selectedCharacterName) selectedCharacterName.textContent = currentCharacter.name; else console.error("updateCharacterUI: selectedCharacterName not found.");

            // Yazıyor göstergesindeki avatar (eğer varsa ve görünürse)
            if (typingAvatarAI) typingAvatarAI.src = currentCharacter.avatar.replace('150x150', '40x40');
            // Not: typingAvatarAI, renderChatMessages içinde yeniden oluşturulur.

            // Not: appendMessage içindeki AI avatarı da currentCharacter'a göre ayarlanır.
        }

        /**
         * Karakter Kartı sekmesindeki bilgileri güncel karaktere göre doldurur.
         */
        function updateCharacterCard() {
            if (!currentCharacter || !cardAvatar || !cardName || !cardDescription || !cardTags || !cardPremiumStatus) { console.error("updateCharacterCard: Required elements or currentCharacter not found."); return; };

            cardAvatar.src = currentCharacter.avatar; // 150x150 kullan
            cardName.textContent = currentCharacter.name;
            cardDescription.textContent = currentCharacter.description;
            cardTags.innerHTML = ''; // Önceki etiketleri temizle

            // Etiketleri ekle
            const tags = currentCharacter.tags || []; // Etiketler yoksa boş array kullan
            tags.forEach(tag => {
                const span = document.createElement('span');
                // Rastgele renk seçimi (Tailwind renk sınıfları)
                const colors = ['blue', 'purple', 'green', 'pink', 'indigo', 'red', 'yellow', 'gray', 'teal'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                span.className = `bg-${color}-100 dark:bg-${color}-900/50 text-${color}-700 dark:text-${color}-300 px-3 py-1 rounded-full text-sm font-medium`;
                span.textContent = tag;
                cardTags.appendChild(span);
            });

            // Premium durumunu göster
            cardPremiumStatus.innerHTML = currentCharacter.isPremium
                ? `<span class="premium-badge text-base px-3 py-1">Premium Karakter</span>`
                : `<span class="bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 px-3 py-1 rounded-full text-sm font-medium">Standart Karakter</span>`;
        }

        /**
         * Sohbet kutusuna yeni bir mesaj ekler ve isteğe bağlı olarak geçmişe kaydeder.
         * @param {string} text Mesaj içeriği.
         * @param {'user' | 'ai' | 'system'} sender Mesajı gönderen ('user', 'ai' veya 'system').
         * @param {string} chatId Mesajın ait olduğu sohbet ID'si.
         * @param {boolean} addToHistory Mesajın geçmişe eklenip eklenmeyeceği.
         */
        function appendMessage(text, sender, chatId = activeChatId, addToHistory = true) {
            if (!chatbox || !chatId) { console.error("appendMessage: chatbox or activeChatId not available."); return; }

            // Sadece aktif sohbetteki mesajları DOM'a ekle
            if (chatId === activeChatId) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('flex', 'items-end', 'space-x-3', 'mb-4');

                if (sender === 'system') { // Sistem mesajları ortalanmış ve farklı stilde
                    messageDiv.classList.add('justify-center', 'w-full');
                    messageDiv.innerHTML = `<div class="text-xs text-gray-500 dark:text-gray-400 italic bg-gray-200/50 dark:bg-gray-700/50 px-3 py-1 rounded-full">${text}</div>`;
                } else { // Kullanıcı ve AI mesajları
                    const isUser = sender === 'user';
                    const avatarInitial = authState.username ? authState.username[0].toUpperCase() : 'M'; // Kullanıcı avatarı için baş harf
                    const avatarUserBgColor = 'bg-gray-300 dark:bg-gray-600';
                    const avatarUserTextColor = 'text-gray-600 dark:text-gray-300';
                    const messageBgColor = isUser ? 'bg-gradient-to-br from-blue-500 to-indigo-600' : 'bg-white dark:bg-gray-700';
                    const messageTextColor = isUser ? 'text-white' : 'text-gray-800 dark:text-gray-200';
                    const roundedCorner = isUser ? 'rounded-br-none' : 'rounded-bl-none'; // Baloncuğun kuyruğu için köşe
                    const userAvatarBorder = 'border-white dark:border-gray-500';
                    const aiAvatarBorder = 'border-white dark:border-gray-600';
                    const ttsIconHTML = !isUser ? `<i class="fas fa-volume-up tts-button" onclick="playTTSPlaceholder(this)"></i>` : ''; // Sadece AI mesajları için TTS butonu
                    const aiAvatarSrc = currentCharacter ? currentCharacter.avatar.replace('150x150', '40x40') : 'https://placehold.co/40x40/cccccc/ffffff?text=?'; // AI avatarı

                    messageDiv.innerHTML = `
                        ${!isUser ? `<img src="${aiAvatarSrc}" alt="AI Avatar" class="w-10 h-10 rounded-full border-2 ${aiAvatarBorder} shadow-md flex-shrink-0">` : ''}
                        <div class="${messageBgColor} ${messageTextColor} p-3 rounded-lg ${roundedCorner} shadow-lg max-w-xs md:max-w-md flex items-center">
                            <p class="text-sm flex-grow">${text}</p>
                            ${ttsIconHTML}
                        </div>
                        ${isUser ? `<div class="flex-shrink-0 h-10 w-10 rounded-full ${avatarUserBgColor} flex items-center justify-center ${avatarUserTextColor} font-semibold border-2 ${userAvatarBorder} shadow-md">${avatarInitial}</div>` : ''}
                    `;
                    if (isUser) messageDiv.classList.add('justify-end'); // Kullanıcı mesajlarını sağa yasla
                }
                // Yazıyor göstergesini mesajdan ÖNCE ekle
                const typingIndicator = chatbox.querySelector('#ai-typing-indicator');
                if (typingIndicator) {
                    chatbox.insertBefore(messageDiv, typingIndicator);
                } else {
                    chatbox.appendChild(messageDiv);
                }
                chatbox.scrollTop = chatbox.scrollHeight; // Yeni mesaj gelince aşağı kaydır
            }

            // Mesajı geçmişe ekle (sistem mesajları hariç ve addToHistory true ise)
            if (sender !== 'system' && addToHistory && allChatHistories[chatId]) {
                const role = sender === 'user' ? 'user' : 'assistant';
                const lastMessage = allChatHistories[chatId][allChatHistories[chatId].length - 1];
                // Aynı rol ve içerikteki mesajı tekrar eklemeyi önle (API yanıtı bazen gecikmeli gelebilir)
                // Bu kontrol sendMessage içindeki backend'den geçmiş alma mantığıyla biraz çakışabilir, dikkatli olunmalı.
                // Şimdilik backend'in geçmişi yönettiğini varsayıyoruz, bu yüzden bu kontrolü kaldırabiliriz.
                // if (!lastMessage || !(lastMessage.role === role && lastMessage.content === text)) {
                    allChatHistories[chatId].push({ role: role, content: text });
                    saveChatsToLocalStorage(); // Geçmişi kaydet
                // }
            }
        }

        /**
         * Kullanıcının mesajını alır, backend API'sine gönderir ve yanıtı işler.
         */
        async function sendMessage() {
            // Gerekli değişkenlerin varlığını kontrol et
            if (!userInput || !authState || !currentModel || !currentCharacter || !activeChatId || !apiUrl) {
                console.error("sendMessage: Gerekli değişkenler/elementler tanımsız veya API URL ayarlanmamış.");
                hideTypingIndicator();
                appendMessage("Mesaj gönderilemiyor. Lütfen ayarları kontrol edin veya sayfayı yenileyin.", "system", activeChatId, false);
                return;
            }
            const messageText = userInput.value.trim();
            if (messageText === '') return; // Boş mesaj gönderme

            // Kullanıcı mesajını ekrana ekle (ve geçmişe - appendMessage hallediyor)
            appendMessage(messageText, 'user', activeChatId, true);
            userInput.value = ''; // Input alanını temizle
            showTypingIndicator(); // AI yazıyor göstergesini göster

            try {
                // Gönderilecek geçmişi al (aktif sohbetin geçmişi)
                // Backend'e tüm geçmişi göndermek yerine son N mesajı göndermek daha verimli olabilir.
                // Şimdilik tüm geçmişi gönderiyoruz, backend bunu işleyebilir.
                const currentHistoryToSend = allChatHistories[activeChatId] || [];
                console.log(`Sending History for Chat ${activeChatId} (last 10):`, JSON.stringify(currentHistoryToSend.slice(-10)));

                // Backend'in /api/chat endpoint'inin beklediği JSON payload'ını oluştur
                const requestBody = {
                    message: messageText,
                    modelId: currentModel.id, // Seçili modelin ID'si
                    // history: currentHistoryToSend, // Backend geçmişi yönetmiyorsa gönderilebilir
                    characterName: currentCharacter.name, // Seçili karakterin adı
                    personaKey: currentPersona, // Seçili persona ('default', 'witty', 'wise', 'custom')
                    customPersonaText: (currentPersona === 'custom' && customPersonaText) ? customPersonaText.value.trim() : '', // Özel persona metni
                    // chatId: activeChatId // Backend'in ihtiyacı varsa gönderilebilir
                };

                console.log("API Request Body:", JSON.stringify(requestBody));

                // Backend API'sine POST isteği gönder
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                });

                hideTypingIndicator(); // Yanıt gelince veya hata olunca göstergeyi gizle

                // API Hata Kontrolü
                if (!response.ok) {
                    let errorMsg = `API Hatası: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        // Backend'den gelen 'error' veya 'reply' alanını kullan (backend hata mesajını reply içinde döndürüyor)
                        errorMsg = errorData.error || errorData.reply || errorMsg;
                    } catch (e) { /* JSON parse edilemezse status code yeterli */ }
                    console.error('API Error:', errorMsg);
                    // Hata mesajını AI mesajı olarak ekle (geçmişe ekleme!)
                    appendMessage(`Üzgünüm, bir hata oluştu: ${errorMsg}`, 'ai', activeChatId, true); // Hata mesajını da geçmişe ekleyelim
                    return;
                }

                // Başarılı Yanıtı İşle
                const data = await response.json();
                const aiReply = data.reply || "Yanıt alınamadı.";

                // AI yanıtını ekrana ekle (ve geçmişe - appendMessage hallediyor)
                appendMessage(aiReply, 'ai', activeChatId, true);

                // Backend'den güncellenmiş geçmiş geliyorsa onu kullanma mantığı (opsiyonel, backend'e bağlı)
                /*
                if (data.history && Array.isArray(data.history)) {
                    allChatHistories[activeChatId] = data.history;
                    saveChatsToLocalStorage(); // Yeni geçmişi kaydet
                    renderChatMessages(activeChatId); // Tüm sohbeti yeniden render et
                    console.log(`Updated History for Chat ${activeChatId} from Backend (last 5):`, JSON.stringify(allChatHistories[activeChatId].slice(-5)));
                } else {
                    // Eğer backend geçmişi döndürmezse, AI yanıtını manuel ekle (zaten yapıldı)
                    console.warn("Backend'den geçerli bir geçmiş verisi alınamadı. Yanıt manuel eklendi.");
                    appendMessage(aiReply, 'ai', activeChatId, true); // Geçmişe ekle
                }
                */

            } catch (error) {
                hideTypingIndicator(); // Ağ hatası durumunda da göstergeyi gizle
                console.error('Fetch Hatası:', error);
                appendMessage('Üzgünüm, sunucuya bağlanırken bir ağ hatası oluştu. Lütfen internet bağlantınızı ve API URL\'sini kontrol edin.', 'ai', activeChatId, true); // Hata mesajını geçmişe ekle
            }
        }

        /** AI yazıyor göstergesini gösterir ve avatarını günceller. */
        function showTypingIndicator() {
            // renderChatMessages içinde #ai-typing-indicator yeniden oluşturulduğu için tekrar bulmamız gerekebilir.
            aiTypingIndicator = document.getElementById('ai-typing-indicator');
            typingAvatarAI = document.getElementById('typingAvatarAI');

            if(aiTypingIndicator && currentCharacter && chatbox && typingAvatarAI) {
                typingAvatarAI.src = currentCharacter.avatar.replace('150x150', '40x40'); // Avatarı güncelle
                aiTypingIndicator.classList.remove('hidden');
                aiTypingIndicator.classList.add('flex');
                chatbox.scrollTop = chatbox.scrollHeight; // Gösterge görünür olsun diye kaydır
            } else {
                console.warn("showTypingIndicator: Elementler bulunamadı veya karakter seçilmedi.");
            }
        }

        /** AI yazıyor göstergesini gizler. */
        function hideTypingIndicator() {
             aiTypingIndicator = document.getElementById('ai-typing-indicator'); // Tekrar bul
             if(aiTypingIndicator) {
                aiTypingIndicator.classList.add('hidden');
                aiTypingIndicator.classList.remove('flex');
            }
        }

        /** TTS (Text-to-Speech) butonu için placeholder fonksiyonu. */
        function playTTSPlaceholder(iconElement) {
            const messageText = iconElement.previousElementSibling?.textContent || "Mesaj bulunamadı";
            console.log("TTS Placeholder:", messageText);
            // Gerçek TTS API entegrasyonu burada yapılabilir.
            alert(`"${messageText.substring(0, 50)}..."\n\nSesli okuma özelliği yakında eklenecektir!`);
        }

        /** Premium modal penceresini gösterir (animasyonlu). */
        function showPremiumModal() {
            if(premiumModal) {
                premiumModal.classList.remove('hidden');
                // Animasyon için küçük bir gecikme
                setTimeout(() => {
                    const modalContent = premiumModal.querySelector('div');
                    if (modalContent) {
                        modalContent.classList.remove('scale-95', 'opacity-0');
                        modalContent.classList.add('scale-100', 'opacity-100');
                    }
                }, 50);
            }
        }

        /** Premium modal penceresini kapatır (animasyonlu). */
        function closePremiumModal() {
            if(premiumModal) {
                const modalContent = premiumModal.querySelector('div');
                if (modalContent) {
                    modalContent.classList.add('scale-95', 'opacity-0');
                    modalContent.classList.remove('scale-100', 'opacity-100');
                }
                // Animasyonun bitmesini bekle ve sonra gizle
                setTimeout(() => premiumModal.classList.add('hidden'), 300);
            }
        }

        /** Karanlık mod temasını uygular veya kaldırır. */
        function applyDarkMode(isDark) {
            document.documentElement.classList.toggle('dark', isDark);
        }

        /** Karanlık mod ayarlarını localStorage'dan yükler ve geçiş butonunu ayarlar. */
        function setupDarkMode() {
            const prefersDark = localStorage.getItem('darkMode') === 'true';
            applyDarkMode(prefersDark);
            if (darkModeToggle) {
                darkModeToggle.checked = prefersDark;
                darkModeToggle.addEventListener('change', (event) => {
                    const isChecked = event.target.checked;
                    applyDarkMode(isChecked);
                    localStorage.setItem('darkMode', isChecked); // Seçimi kaydet
                });
            }
        }

        /** Persona ayarlarını localStorage'dan yükler ve select/textarea elemanlarını ayarlar. */
        function setupPersonaSettings() {
            if (!personaSelect || !customPersonaInputDiv || !customPersonaText) { console.warn("Persona elements not found."); return; }
            const savedPersona = localStorage.getItem('aiPersona') || 'default';
            const savedCustomText = localStorage.getItem('aiCustomPersonaText') || '';
            personaSelect.value = savedPersona;
            customPersonaText.value = savedCustomText;
            currentPersona = savedPersona; // Başlangıç personasını state'e ata
            // Özel persona seçiliyse ilgili input alanını göster
            customPersonaInputDiv.style.display = (savedPersona === 'custom') ? 'block' : 'none';
            // Select değiştiğinde özel inputu göster/gizle
            personaSelect.addEventListener('change', (e) => {
                customPersonaInputDiv.style.display = (e.target.value === 'custom') ? 'block' : 'none';
            });
        }

        /** Seçilen persona ayarlarını kaydeder ve kullanıcıyı bilgilendirir. */
        function savePersonaSettings() {
            if (!personaSelect || !customPersonaText || !savePersonaButton) return;
            const selectedPersona = personaSelect.value;
            const customText = customPersonaText.value.trim();

            // Özel persona seçiliyse ama metin boşsa uyarı ver
            if (selectedPersona === 'custom' && customText === '') {
                alert('Lütfen özel persona tanımını girin veya farklı bir persona seçin.');
                return;
            }

            currentPersona = selectedPersona; // Uygulama state'ini güncelle
            localStorage.setItem('aiPersona', selectedPersona); // LocalStorage'a kaydet
            if (selectedPersona === 'custom') {
                localStorage.setItem('aiCustomPersonaText', customText);
            } else {
                localStorage.removeItem('aiCustomPersonaText'); // Özel değilse sil
            }

            appendMessage(`Persona "${selectedPersona === 'custom' ? 'Özel Tanım' : personaSelect.options[personaSelect.selectedIndex].text}" olarak ayarlandı.`, 'system');
            console.log("Persona kaydedildi:", currentPersona, customText);
            // Butona geçici bir onaylama efekti eklenebilir
            savePersonaButton.textContent = "Kaydedildi!";
            savePersonaButton.classList.add('bg-green-500');
            setTimeout(() => {
                 savePersonaButton.textContent = "Personayı Kaydet";
                 savePersonaButton.classList.remove('bg-green-500');
            }, 1500);
        }


        // --- Login/Logout Fonksiyonları ---

        /**
         * Kullanıcı veya admin girişini doğrular ve arayüzü günceller.
         * @param {Event} event Form submit olayı.
         * @param {boolean} isAdminLogin Admin girişi mi yapılıyor?
         */
        function handleLogin(event, isAdminLogin = false) {
            event.preventDefault(); // Formun sayfayı yenilemesini engelle
            if(loginError) loginError.classList.add('hidden'); // Hata mesajını gizle

            const usernameInput = isAdminLogin ? document.getElementById('admin-username') : document.getElementById('username');
            const passwordInput = isAdminLogin ? document.getElementById('admin-password') : document.getElementById('password');

            if (!usernameInput || !passwordInput) {
                console.error("Login input element not found!");
                if(loginError) { loginError.textContent = "Giriş formu elemanları bulunamadı."; loginError.classList.remove('hidden'); }
                return;
            }

            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            // Basit kimlik doğrulama (Gerçek uygulamada bu backend'de yapılmalı!)
            let loggedIn = false;
            let userIsAdmin = false;
            let userIsPremium = false;

            if (isAdminLogin) { // Admin girişi kontrolü
                if (username === 'admin' && password === 'admin12345') {
                    loggedIn = true; userIsAdmin = true; userIsPremium = true; // Admin aynı zamanda premium
                }
            } else { // Kullanıcı/Premium girişi kontrolü
                if (username === 'premium' && password === '123') {
                    loggedIn = true; userIsPremium = true;
                } else if (username === 'user' && password === '123') {
                    loggedIn = true; userIsPremium = false;
                }
                // Başka kullanıcılar eklenebilir...
            }

            if (loggedIn) { // Giriş başarılıysa
                authState = { isLoggedIn: true, isAdmin: userIsAdmin, isPremium: userIsPremium, username: username };
                localStorage.setItem('authState', JSON.stringify(authState)); // Oturum durumunu kaydet
                loadChatsFromLocalStorage(); // Kullanıcıya ait sohbetleri yükle
                showAppInterface(); // Ana uygulama arayüzünü göster
            } else { // Giriş başarısızsa
                if(loginError) { loginError.textContent = "Geçersiz kullanıcı adı veya şifre."; loginError.classList.remove('hidden'); }
            }
        }

        /** Misafir olarak devam etme fonksiyonu. */
        function continueAsGuest() {
            authState = { isLoggedIn: false, isAdmin: false, username: "Misafir", isPremium: false };
            // Misafir için de sohbetleri yükle (veya temizle, tercihe bağlı)
            loadChatsFromLocalStorage();
            showAppInterface();
        }

        /** Oturumu kapatır, durumu sıfırlar ve giriş ekranını gösterir. */
        function logout() {
            authState = { isLoggedIn: false, isAdmin: false, username: null, isPremium: false };
            localStorage.removeItem('authState');
            // Çıkış yapınca sohbetleri de temizle (isteğe bağlı)
            localStorage.removeItem('allChatHistories');
            localStorage.removeItem('activeChatId');
            allChatHistories = {};
            activeChatId = null;
            showLoginScreen(); // Giriş ekranını göster
        }


        // --- UI Gösterme/Gizleme ---

        /** Giriş ekranını gösterir, uygulama arayüzünü gizler. */
        function showLoginScreen() {
            if(loginScreen) loginScreen.classList.remove('hidden');
            if(appContainer) {
                appContainer.classList.add('hidden');
                appContainer.classList.remove('visible', 'flex'); // 'flex' de kaldırılmalı
            }
        }

        /** Uygulama arayüzünü gösterir, giriş ekranını gizler ve UI güncellemelerini yapar. */
        function showAppInterface() {
            if(loginScreen) loginScreen.classList.add('hidden');
            if(appContainer) {
                appContainer.classList.remove('hidden');
                appContainer.classList.add('visible', 'flex'); // 'flex' eklenmeli
                updateUIAfterLogin(); // Giriş sonrası UI güncellemelerini yap
            } else {
                console.error("Uygulama konteyneri (#app-container) bulunamadı!");
            }
        }


        // --- Giriş Sonrası/Misafir UI Güncellemeleri ---

        /** Kullanıcının oturum durumuna göre UI elemanlarını (menüler, durum yazısı vb.) günceller. */
        function updateUIAfterLogin() {
            if (!menuUploadCharacter || !menuSettings || !userStatusDiv || !premiumUpgradeButton || !logoutButton) {
                console.error("updateUIAfterLogin: UI elements not found.");
                return;
            }

            // Admin/Ayarlar menülerini göster/gizle
            // 'hidden' sınıfı display: none yapar. 'flex' ekleyip kaldırmak daha doğru olabilir.
            menuUploadCharacter.classList.toggle('hidden', !authState.isAdmin);
            menuUploadCharacter.classList.toggle('flex', authState.isAdmin);

            // Ayarlar menüsü herkes için görünür olsun
            menuSettings.classList.remove('hidden');
            menuSettings.classList.add('flex');

            // Kullanıcı durumunu yazdır
            let statusText = "Misafir";
            if (authState.isLoggedIn) {
                if (authState.isAdmin) { statusText = "Admin"; }
                else if (authState.isPremium) { statusText = "Premium Kullanıcı ✨"; }
                else { statusText = "Standart Kullanıcı"; }
            }
            userStatusDiv.textContent = `Durum: ${statusText}`;

            // Premium yükseltme butonunu göster/gizle (Sadece giriş yapmış, premium olmayan standart kullanıcılar için)
            premiumUpgradeButton.classList.toggle('hidden', !authState.isLoggedIn || authState.isPremium || authState.isAdmin);

            // Çıkış yap butonunu göster/gizle (Sadece giriş yapmış kullanıcılar için)
            logoutButton.classList.toggle('hidden', !authState.isLoggedIn);

            // Modelleri, mağazayı ve sohbet listesini yeniden başlat/render et
            initializeModels(); // Model listesini kullanıcının durumuna göre günceller
            initializeStore(); // Mağazayı kullanıcının durumuna göre günceller
            renderChatList(); // Sohbet listesini render eder

            // Aktif sohbeti yükle veya yeni sohbet başlat
            if (!activeChatId || !allChatHistories[activeChatId]) {
                // Eğer kayıtlı sohbet yoksa veya aktif ID geçersizse yeni sohbet başlat
                startNewChat(true); // İlk mesajları render et
            } else {
                // Kayıtlı aktif sohbeti yükle
                switchChat(activeChatId);
            }
             // Başlangıçta sohbet sekmesini göster
             showSection('chat');
        }


        // --- Başlangıç Ayarları ve Olay Dinleyiciler ---

        /** Mevcut AI modellerini model seçim listesine (select) ekler ve olay dinleyicisini ayarlar. */
        function initializeModels() {
            if (!modelSelect) { console.warn("Model select element not found."); return; }
            modelSelect.innerHTML = ''; // Listeyi temizle

            if (availableModels.length === 0) { // Model yoksa veya yükleniyorsa
                const loadingOption = document.createElement('option');
                loadingOption.textContent = "Modeller yükleniyor...";
                loadingOption.disabled = true;
                modelSelect.appendChild(loadingOption);
                currentModel = null; // Seçili model yok
                if (modelDetailsDisplay) modelDetailsDisplay.classList.add('hidden');
                return;
            }

            // Modelleri listeye ekle
            availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = model.name + (model.isFree ? ' (Ücretsiz)' : '') + (model.isPremium ? ' (Premium ✨)' : '');

                // Premium kontrolü (Admin veya Premium değilse seçilemez yap - Şimdilik sadece etiket gösteriliyor)
                // if (model.isPremium && !authState.isPremium && !authState.isAdmin) {
                //     option.disabled = true;
                // }

                option.classList.add('bg-white', 'dark:bg-gray-700', 'text-gray-900', 'dark:text-gray-200');
                modelSelect.appendChild(option);
            });

             // Kayıtlı modeli veya varsayılanı seçili yap
             const savedModelId = localStorage.getItem('selectedModelId');
             // Önce kayıtlıyı, sonra gemini-pro'yu, sonra ilk modeli dene
             const modelToSelect = availableModels.find(m => m.id === savedModelId) ||
                                 availableModels.find(m => m.id === "gemini-pro") ||
                                 (availableModels.length > 0 ? availableModels[0] : null);

             if (modelToSelect) {
                 currentModel = modelToSelect;
                 modelSelect.value = currentModel.id;
                 displayModelDetailsFrontend(currentModel.id);
             } else {
                 currentModel = null; // Hiç model yoksa
                 if (modelDetailsDisplay) modelDetailsDisplay.classList.add('hidden');
                 appendMessage("Kullanılabilir AI modeli bulunamadı. Lütfen ayarları kontrol edin.", "system", activeChatId, false);
             }

             // Model seçimi değiştiğinde localStorage'a kaydet ve modeli güncelle
             // Önceki listener'ı kaldırıp yenisini eklemek daha güvenli olabilir
             modelSelect.removeEventListener('change', handleModelChange); // Öncekini kaldır
             modelSelect.addEventListener('change', handleModelChange); // Yenisini ekle
        }

        /** Model select değiştiğinde çağrılan fonksiyon */
        function handleModelChange(e) {
             selectModel(e.target.value); // Modeli seç
             localStorage.setItem('selectedModelId', e.target.value); // Seçimi kaydet
        }

        /** Karakter mağazasını `availableCharacters` listesine göre doldurur. */
        function initializeStore() {
            if (!storeGrid) { console.warn("Store grid element not found."); return; }
            storeGrid.innerHTML = ''; // Mağazayı temizle

            availableCharacters.forEach(char => {
                const card = document.createElement('div');
                card.className = 'store-card p-4 rounded-lg shadow-md text-center relative overflow-hidden' + (char.isPremium ? ' premium' : '');
                // Karta tıklandığında karakteri seç veya premium modalı göster
                card.onclick = () => {
                    if (char.isPremium && !authState.isPremium && !authState.isAdmin) {
                        showPremiumModal();
                        appendMessage(`${char.name} karakterini kullanmak için Premium üye olmalısınız.`, "system");
                    } else {
                        selectCharacter(char.id);
                        showSection('chat'); // Karakter seçince sohbete dön
                    }
                };
                // Kart içeriği
                card.innerHTML = `
                    <img src="${char.avatar}" alt="${char.name}" class="w-24 h-24 rounded-full mx-auto mb-3 border-2 border-white dark:border-gray-500 shadow-sm">
                    <h4 class="font-semibold text-gray-800 dark:text-gray-100">${char.name}</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">${(char.tags || []).join(', ')}</p>
                    ${char.isPremium
                        ? '<span class="premium-badge absolute top-2 right-2">Premium</span><div class="premium-overlay"><i class="fas fa-lock mr-1"></i> Premium</div>'
                        : '<span class="absolute top-2 right-2 text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 px-2 py-0.5 rounded-full">Ücretsiz</span>'
                    }
                `;
                storeGrid.appendChild(card);
            });
        }


        // --- Çoklu Sohbet Fonksiyonları ---

        /** Benzersiz bir sohbet ID'si oluşturur (timestamp + rastgele dize). */
        function generateChatId() {
            return `chat_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`;
        }

        /** Tüm sohbet geçmişlerini ve aktif sohbet ID'sini localStorage'a kaydeder. */
        function saveChatsToLocalStorage() {
            try {
                localStorage.setItem('allChatHistories', JSON.stringify(allChatHistories));
                localStorage.setItem('activeChatId', activeChatId);
            } catch (e) {
                console.error("LocalStorage'a kaydetme hatası:", e);
                // Kullanıcıyı bilgilendirme veya eski sohbetleri silme gibi stratejiler eklenebilir
                alert("Sohbet geçmişi kaydedilemedi. Tarayıcı depolama alanı dolu olabilir.");
            }
        }

        /** Sohbet geçmişlerini ve aktif ID'yi localStorage'dan yükler. */
        function loadChatsFromLocalStorage() {
            const savedChats = localStorage.getItem('allChatHistories');
            const savedActiveId = localStorage.getItem('activeChatId');
            try {
                allChatHistories = savedChats ? JSON.parse(savedChats) : {};
            } catch (e) {
                console.error("LocalStorage'dan sohbetler okunurken hata:", e);
                allChatHistories = {}; // Hata durumunda sıfırla
            }
            activeChatId = savedActiveId || null;

            // Yüklenen aktif ID'nin hala geçerli olup olmadığını kontrol et
            if (activeChatId && !allChatHistories[activeChatId]) {
                console.warn(`Aktif sohbet ID'si (${activeChatId}) geçersiz, sıfırlanıyor.`);
                activeChatId = null; // Geçersizse sıfırla
                localStorage.removeItem('activeChatId');
            }
        }


        /** Sol menüdeki sohbet listesini `allChatHistories`'e göre render eder. */
        function renderChatList() {
            if (!chatListElement) { console.warn("Chat list element not found."); return; }
            chatListElement.innerHTML = ''; // Listeyi temizle
            const chatIds = Object.keys(allChatHistories);

            if (chatIds.length === 0) {
                chatListElement.innerHTML = '<li class="px-4 py-2 text-gray-400 italic">Henüz sohbet yok.</li>';
                return;
            }

            // Sohbetleri listele (ID'ye göre ters sırada - en yeni en üstte)
            chatIds.sort().reverse().forEach(chatId => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'chat-list-item w-full text-left';
                button.dataset.chatId = chatId;

                // Sohbet adı olarak ilk kullanıcı mesajını veya ID'yi kullan
                const firstUserMessage = allChatHistories[chatId]?.find(msg => msg.role === 'user')?.content;
                const chatName = firstUserMessage
                    ? firstUserMessage.substring(0, 20) + (firstUserMessage.length > 20 ? '...' : '')
                    : `Sohbet ${chatId.substring(5, 10)}`; // ID'nin bir kısmını göster

                button.textContent = chatName;
                button.onclick = () => switchChat(chatId); // Tıklanınca sohbete geç

                // Aktif sohbeti vurgula
                if (chatId === activeChatId) {
                    button.classList.add('active');
                }

                li.appendChild(button);
                chatListElement.appendChild(li);
            });
        }

        /** Belirtilen sohbet ID'sine ait mesajları chatbox'a render eder. */
        function renderChatMessages(chatId) {
            if (!chatbox || !allChatHistories[chatId]) {
                if(chatbox) chatbox.innerHTML = ''; // Sohbet yoksa veya geçersizse chatbox'ı temizle
                // Belki "Sohbet bulunamadı" mesajı gösterilebilir
                console.warn(`renderChatMessages: Sohbet bulunamadı veya chatbox yok: ${chatId}`);
                return;
            }
            chatbox.innerHTML = ''; // Önce mevcut mesajları temizle

            // AI yazıyor göstergesini HTML olarak ekle (başlangıçta gizli)
            const typingIndicatorHTML = `
                <div id="ai-typing-indicator" class="ai-typing hidden">
                    <img id="typingAvatarAI" src="${currentCharacter?.avatar?.replace('150x150','40x40') || 'https://placehold.co/40x40/cccccc/ffffff?text=?'}" alt="AI Avatar" class="w-10 h-10 rounded-full border-2 border-white dark:border-gray-600 shadow-md flex-shrink-0">
                    <div class="bg-white dark:bg-gray-700 p-3 rounded-lg rounded-bl-none shadow-lg">
                        <div class="typing-indicator-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            chatbox.innerHTML = typingIndicatorHTML;

            // Typing indicator elementlerini tekrar bulmamız gerekiyor
            aiTypingIndicator = document.getElementById('ai-typing-indicator');
            typingAvatarAI = document.getElementById('typingAvatarAI');


            // Geçmişteki mesajları ekle
            const historyToRender = allChatHistories[chatId];
            historyToRender.forEach(message => {
                const sender = message.role === 'user' ? 'user' : (message.role === 'assistant' ? 'ai' : 'system');
                // Mesajı DOM'a ekle (geçmişe tekrar ekleme!)
                 if (sender !== 'system') { // Sistem mesajları render edilmiyor (isteğe bağlı)
                    appendMessage(message.content, sender, chatId, false);
                 } else {
                    // Sistem mesajlarını da render etmek isterseniz:
                    // appendMessage(message.content, 'system', chatId, false);
                 }
            });
             // Typing indicator'ı en sona taşı (appendMessage bunu zaten yapıyor)
             // if (aiTypingIndicator) chatbox.appendChild(aiTypingIndicator);
        }


        /** Yeni bir sohbet başlatır, ID oluşturur ve UI'ı günceller. */
        function startNewChat(renderInitialMessage = true) {
            const newId = generateChatId(); // Yeni ID oluştur
            allChatHistories[newId] = []; // Boş geçmiş oluştur
            activeChatId = newId; // Aktif ID'yi güncelle
            saveChatsToLocalStorage(); // Kaydet
            renderChatList(); // Sol menüyü güncelle

            renderChatMessages(newId); // Yeni boş sohbeti ekranda göster
            if (renderInitialMessage) {
                 appendMessage("Yeni sohbet başlatıldı!", "system", newId, false); // Sistem mesajı ekle
            }
            showSection('chat'); // Sohbet sekmesini aktif yap
        }

        /** Belirtilen ID'deki sohbete geçer ve UI'ı günceller. */
        function switchChat(chatId) {
            if (!allChatHistories[chatId]) {
                console.error(`Sohbet bulunamadı: ${chatId}`);
                // Belki kullanıcıyı bilgilendirip yeni sohbet başlatılabilir
                startNewChat(true);
                return; // Geçersiz ID ise çık
            }
            activeChatId = chatId; // Aktif ID'yi güncelle
            saveChatsToLocalStorage(); // Kaydet
            renderChatList(); // Sol menüyü güncelle (aktif sohbeti vurgulamak için)
            renderChatMessages(chatId); // Seçilen sohbetin mesajlarını göster
            showSection('chat'); // Sohbet sekmesini aktif yap
        }


        // --- Ana Başlatma Fonksiyonu ---
        /** Uygulamayı başlatır, elementleri bulur, ayarları yükler ve olay dinleyicilerini ekler. */
        async function initializeApp() {
            console.log("initializeApp başlıyor...");

            // DOM elementlerini bul ve değişkenlere ata
            loginScreen = document.getElementById('login-screen');
            appContainer = document.getElementById('app-container');
            userLoginForm = document.getElementById('user-login-form');
            adminLoginForm = document.getElementById('admin-login-form');
            continueGuestButton = document.getElementById('continue-guest-button');
            loginError = document.getElementById('login-error');
            sidebar = document.getElementById('sidebar');
            sidebarNav = document.getElementById('sidebar-nav');
            mainContent = document.getElementById('main-content');
            menuToggle = document.getElementById('menu-toggle');
            headerTitle = document.getElementById('header-title');
            contentSections = document.querySelectorAll('.content-section');
            chatbox = document.getElementById('chatbox');
            userInput = document.getElementById('userInput');
            sendButton = document.getElementById('sendButton');
            micButton = document.getElementById('micButton');
            // aiTypingIndicator ve typingAvatarAI renderChatMessages içinde atanacak
            selectedCharacterAvatar = document.getElementById('selectedCharacterAvatar');
            selectedCharacterName = document.getElementById('selectedCharacterName');
            characterDropdown = document.getElementById('characterDropdown');
            premiumModal = document.getElementById('premiumModal');
            modelSelect = document.getElementById('model-select');
            modelDetailsDisplay = document.getElementById('model-details-display');
            storeGrid = document.getElementById('store-grid');
            uploadForm = document.getElementById('upload-form');
            darkModeToggle = document.getElementById('darkModeToggle');
            personaSelect = document.getElementById('persona-select');
            customPersonaInputDiv = document.getElementById('custom-persona-input');
            customPersonaText = document.getElementById('custom-persona-text');
            cardAvatar = document.getElementById('card-avatar');
            cardName = document.getElementById('card-name');
            cardDescription = document.getElementById('card-description');
            cardTags = document.getElementById('card-tags');
            cardPremiumStatus = document.getElementById('card-premium-status');
            userStatusDiv = document.getElementById('user-status');
            premiumUpgradeButton = document.getElementById('premium-upgrade-button');
            menuUploadCharacter = document.getElementById('menu-upload-character');
            menuSettings = document.getElementById('menu-settings');
            logoutButton = document.getElementById('logout-button');
            modelLoadingIndicator = document.getElementById('model-loading-indicator');
            modelErrorIndicator = document.getElementById('model-error-indicator');
            newChatButton = document.getElementById('new-chat-button');
            chatListElement = document.getElementById('chat-list');
            characterSelectButton = document.getElementById('character-select-button');
            savePersonaButton = document.getElementById('save-persona-button');

            // Temel elementlerin varlığını kontrol et
            if (!loginScreen || !appContainer || !userLoginForm || !adminLoginForm || !continueGuestButton || !sidebarNav || !modelSelect || !newChatButton || !chatListElement || !chatbox || !userInput || !sendButton) {
                console.error("Initialization Error: Core UI elements not found!");
                document.body.innerHTML = '<div style="padding: 20px; text-align: center; color: red; font-size: 1.2em;">Uygulama yüklenemedi. Lütfen konsolu kontrol edin veya sayfayı yenileyin.</div>';
                return;
            }
             console.log("Core elements found.");

            // Modelleri çek (asenkron)
            await fetchOpenRouterModels();
            console.log("Models fetched/initialized.");

            // Oturum ve sohbet durumunu localStorage'dan yükle
            loadChatsFromLocalStorage();
            const savedAuthState = localStorage.getItem('authState');
            if (savedAuthState) {
                try { authState = JSON.parse(savedAuthState); } catch(e) { console.error("Error parsing authState:", e); localStorage.removeItem('authState'); }
            }
            console.log("Auth state loaded:", authState);
            console.log("Chats loaded. Active chat ID:", activeChatId);

            // Arayüzü göster (giriş veya ana ekran)
            if (authState.isLoggedIn) {
                showAppInterface(); // Bu fonksiyon içinde updateUIAfterLogin çağrılıyor
            } else {
                showLoginScreen();
            }
             console.log("Initial interface shown.");

            // Karakter dropdown içeriğini doldur
            if (characterDropdown) {
                characterDropdown.innerHTML = ''; // Temizle
                availableCharacters.forEach(char => {
                    const button = document.createElement('button');
                    button.className = 'block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-600 flex items-center justify-between';
                    button.onclick = () => selectCharacter(char.id);
                    button.innerHTML = `<span>${char.name}</span> ${char.isPremium ? '<span class="premium-badge">Premium</span>' : ''}`;
                    characterDropdown.appendChild(button);
                });
            } else { console.warn("Character dropdown element not found."); }

            // Diğer başlangıç ayarları
            initializeStore(); // Mağazayı doldur
            updateCharacterUI(); // Başlangıç karakterini UI'da göster
            setupDarkMode(); // Karanlık mod ayarlarını yap
            setupPersonaSettings(); // Persona ayarlarını yap
            console.log("Store, UI, Dark Mode, Persona initialized.");

            // --- Olay Dinleyicileri ---
            userLoginForm.addEventListener('submit', (e) => handleLogin(e, false));
            adminLoginForm.addEventListener('submit', (e) => handleLogin(e, true));
            continueGuestButton.addEventListener('click', continueAsGuest);
            newChatButton.addEventListener('click', () => startNewChat(true));
            if (logoutButton) logoutButton.addEventListener('click', logout);
            if (menuToggle) menuToggle.addEventListener('click', () => {
                if(sidebar) sidebar.classList.toggle('-translate-x-full');
            });
            if (sendButton) sendButton.addEventListener('click', sendMessage);
            if (userInput) userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }); // Shift+Enter ile yeni satır
            if (micButton) micButton.addEventListener('click', () => alert('Sesli giriş özelliği henüz aktif değil.'));
            // Model select listener'ı initializeModels içinde eklendi.
            if (uploadForm) uploadForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!authState.isAdmin) { appendMessage("Bu işlem için admin yetkisi gerekli.", "system"); return; }
                const formData = new FormData(uploadForm);
                const newCharacter = {
                    id: formData.get('name').toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''), // ID oluştur (basit)
                    name: formData.get('name'),
                    avatar: formData.get('avatar'),
                    description: formData.get('description'),
                    tags: formData.get('tags') ? formData.get('tags').split(',').map(t => t.trim()).filter(t => t) : ['Yeni'],
                    isPremium: formData.get('isPremium') === 'true',
                    jsonData: formData.get('json_data') // Ek veri (şu an kullanılmıyor)
                };
                if (!newCharacter.name || !newCharacter.avatar || !newCharacter.description) {
                    alert('Lütfen Ad, Avatar URL ve Açıklama alanlarını doldurun.'); return;
                }
                // Yeni karakteri listeye ekle (sadece frontend tarafında, kalıcı değil)
                availableCharacters.push(newCharacter);
                // Mağazayı ve dropdown'ı güncelle
                initializeStore();
                 // Dropdown'ı da güncelle
                 if (characterDropdown) {
                     const button = document.createElement('button');
                     button.className = 'block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-gray-600 flex items-center justify-between';
                     button.onclick = () => selectCharacter(newCharacter.id);
                     button.innerHTML = `<span>${newCharacter.name}</span> ${newCharacter.isPremium ? '<span class="premium-badge">Premium</span>' : ''}`;
                     characterDropdown.appendChild(button);
                 }
                alert(`${newCharacter.name} karakteri başarıyla yüklendi (simülasyon)! Gerçek bir veritabanı entegrasyonu gereklidir.`);
                uploadForm.reset();
                showSection('character-store'); // Mağazaya yönlendir
            });

            // Karakter dropdown açma/kapama
            if (characterSelectButton && characterDropdown) {
                characterSelectButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Olayın document'a yayılmasını engelle
                    characterDropdown.classList.toggle('hidden');
                });
                // Dışarı tıklandığında dropdown'ı kapat
                document.addEventListener('click', (event) => {
                    if (!characterSelectButton.contains(event.target) && !characterDropdown.contains(event.target)) {
                        characterDropdown.classList.add('hidden');
                    }
                });
            } else { console.warn("Character select button or dropdown not found."); }

            // Persona kaydetme butonu
            if (savePersonaButton) savePersonaButton.addEventListener('click', savePersonaSettings);

            // Sidebar navigasyon linkleri
            sidebarNav.addEventListener('click', (e) => {
                const link = e.target.closest('.sidebar-link');
                if (link && link.dataset.section) {
                    e.preventDefault();
                    showSection(link.dataset.section);
                }
            });
             console.log("Event listeners added.");
             console.log("initializeApp finished.");
        }

        // Uygulamayı Başlat (DOM yüklendikten sonra)
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
